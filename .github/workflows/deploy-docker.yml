name: Docker Deploy to Production

on:
  push:
    branches: [main, master]
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Code
      uses: actions/checkout@v3

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2

    - name: Build Docker Image
      run: |
        docker build -t audiotexthub:latest .
        docker save audiotexthub:latest | gzip > audiotexthub.tar.gz

    - name: Upload Docker Image
      uses: appleboy/scp-action@master
      with:
        host: ${{ secrets.DEPLOY_HOST }}
        port: ${{ secrets.DEPLOY_PORT }}
        username: ${{ secrets.DEPLOY_USER }}
        password: ${{ secrets.DEPLOY_PASS }}
        source: "audiotexthub.tar.gz,docker-compose.prod.yml,Dockerfile"
        target: "/tmp/"

    - name: Deploy to Server
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.DEPLOY_HOST }}
        port: ${{ secrets.DEPLOY_PORT }}
        username: ${{ secrets.DEPLOY_USER }}
        password: ${{ secrets.DEPLOY_PASS }}
        command_timeout: 30m
        script: |
          set -e

          APP_DIR="/var/www/audiotexthub"
          BACKUP_DIR="${APP_DIR}/backups"
          TIMESTAMP=$(date +%Y%m%d_%H%M%S)

          echo "åˆ›å»ºç›®å½•ç»“æ„..."
          sudo mkdir -p ${APP_DIR}/{backups,logs,ssl}
          sudo chown -R $USER:$USER ${APP_DIR}
          cd ${APP_DIR}

          if [ -f "docker-compose.prod.yml" ]; then
            echo "å¤‡ä»½å½“å‰é…ç½®..."
            cp docker-compose.prod.yml ${BACKUP_DIR}/docker-compose.prod.yml.${TIMESTAMP}
          fi

          cp /tmp/docker-compose.prod.yml ${APP_DIR}/
          cp /tmp/Dockerfile ${APP_DIR}/

          if ! command -v docker &> /dev/null; then
            echo "Docker æœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£… Dockerï¼"
            exit 1
          fi

          if ! command -v docker-compose &> /dev/null && ! docker compose version &> /dev/null; then
            echo "Docker Compose æœªå®‰è£…ï¼Œæ­£åœ¨å®‰è£…..."
            sudo curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
            sudo chmod +x /usr/local/bin/docker-compose
          fi

          echo "åŠ è½½ Docker é•œåƒ..."
          sudo docker load < /tmp/audiotexthub.tar.gz
          rm -f /tmp/audiotexthub.tar.gz

          if [ ! -f "${APP_DIR}/.env" ]; then
            echo "è­¦å‘Šï¼š.env æ–‡ä»¶ä¸å­˜åœ¨ï¼æ­£åœ¨åˆ›å»ºé»˜è®¤é…ç½®..."
            cat > "${APP_DIR}/.env" << 'EOF'
# åŸºç¡€é…ç½®
NEXT_PUBLIC_API_URL=http://localhost:3000
AUTH_SECRET=your-auth-secret-here
NEXT_PUBLIC_APP_NAME=AudioTextHub
NEXT_PUBLIC_ENABLE_PROTECT=false
NEXT_PUBLIC_ENABLE_STRIPE=false
NEXT_PUBLIC_ENABLE_BILLING=false
NEXT_PUBLIC_ENABLE_LANDINGPAGE=true

# æ•°æ®åº“é…ç½®ï¼ˆå¦‚æœä½¿ç”¨ï¼‰
DATABASE_URL=
DATABASE_AUTH_TOKEN=

# ç¬¬ä¸‰æ–¹æœåŠ¡é…ç½®ï¼ˆå¯é€‰ï¼‰
GOOGLE_CLIENT_ID=
GOOGLE_CLIENT_SECRET=
AWS_ACCESS_KEY_ID=
AWS_SECRET_ACCESS_KEY=
AWS_ENDPOINT_URL_S3=
S3_BUCKET_NAME=
S3_BUCKET_ENDPOINT=
BAIDU_TRANSLATE_APPID=
BAIDU_TRANSLATE_KEY=
WEBHOOK_SECRET=
NEXT_PUBLIC_GEMINI_API_KEY=
NEXT_PUBLIC_SUPABASE_URL=
NEXT_PUBLIC_SUPABASE_ANON_KEY=
UMAMI_URL=
UMAMI_TOKEN=
NEXT_PUBLIC_UMAMI_URL=
NEXT_PUBLIC_UMAMI_WEBSITE_ID=
NEXT_PUBLIC_UMAMI_SRC=
INNGEST_EVENT_KEY=
INNGEST_SIGNING_KEY=
NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY=
STRIPE_SECRET_KEY=
STRIPE_WEBHOOK_SECRET=
RESEND_EMAIL_FROM=
RESEND_API_KEY=
SENTRY_AUTH_TOKEN=
NEXT_PUBLIC_SENTRY_DSN=
EOF
            echo "âœ… å·²åˆ›å»ºé»˜è®¤ .env æ–‡ä»¶ï¼Œè¯·æ ¹æ®éœ€è¦ä¿®æ”¹é…ç½®"
          else
            echo "âœ… .env æ–‡ä»¶å·²å­˜åœ¨"
          fi

          echo "åœæ­¢æ—§å®¹å™¨..."
          docker-compose -f docker-compose.prod.yml down || docker compose -f docker-compose.prod.yml down || true

          echo "å¯åŠ¨æ–°å®¹å™¨..."
          if command -v docker-compose &> /dev/null; then
            docker-compose -f docker-compose.prod.yml up -d
          else
            docker compose -f docker-compose.prod.yml up -d
          fi

          echo "ç­‰å¾…æœåŠ¡å¯åŠ¨..."
          sleep 10

          CONTAINER=$(docker ps --format "{{.Names}}" | grep audiotexthub | head -1)

          echo "å®¹å™¨çŠ¶æ€ï¼š"
          docker ps -a | grep audiotexthub || true

          echo "æœ€è¿‘çš„åº”ç”¨æ—¥å¿—ï¼š"
          docker logs --tail 50 "$CONTAINER" || true

          echo "æ¸…ç†æœªä½¿ç”¨çš„é•œåƒ..."
          docker image prune -f || true

          echo "éƒ¨ç½²å®Œæˆï¼"

    - name: Health Check
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.DEPLOY_HOST }}
        port: ${{ secrets.DEPLOY_PORT }}
        username: ${{ secrets.DEPLOY_USER }}
        password: ${{ secrets.DEPLOY_PASS }}
        script: |
          echo "æ‰§è¡Œå¥åº·æ£€æŸ¥..."

          CONTAINER=$(docker ps --format "{{.Names}}" | grep audiotexthub | head -1)

          if ! docker ps | grep -q "$CONTAINER"; then
            echo "âŒ åº”ç”¨å®¹å™¨æœªè¿è¡Œï¼"
            docker ps -a
            exit 1
          fi

          MAX_ATTEMPTS=10
          ATTEMPT=1

          while [ $ATTEMPT -le $MAX_ATTEMPTS ]; do
            echo "å¥åº·æ£€æŸ¥å°è¯• $ATTEMPT/$MAX_ATTEMPTS..."
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:80 || echo "000")
            echo "HTTP å“åº”ç : $HTTP_CODE"

            if [ "$HTTP_CODE" = "200" ]; then
              echo "âœ… å¥åº·æ£€æŸ¥é€šè¿‡ï¼"
              docker ps | grep "$CONTAINER" || true
              ss -tlpn | grep -E ':80|:3000' || netstat -tlpn | grep -E ':80|:3000' || true
              echo "æµ‹è¯•APIç«¯ç‚¹..."
              curl -s http://localhost/api/ping | head -100 || echo "APIæµ‹è¯•å¤±è´¥ï¼Œä½†æœåŠ¡å¯èƒ½æ­£å¸¸è¿è¡Œ"
              exit 0
            else
              echo "ç­‰å¾…æœåŠ¡å“åº”..."
              sleep 5
            fi

            ATTEMPT=$((ATTEMPT + 1))
          done

          echo "âŒ å¥åº·æ£€æŸ¥å¤±è´¥ï¼"
          docker logs --tail 100 "$CONTAINER" || true
          exit 1

    - name: Cleanup
      if: always()
      run: rm -f audiotexthub.tar.gz

    - name: Success Notification
      if: success()
      run: |
        echo "ğŸ‰ AudioTextHub Docker éƒ¨ç½²æˆåŠŸï¼"
        echo "éƒ¨ç½²æ—¶é—´: $(date)"
        echo "Git æäº¤: ${{ github.sha }}"
        echo "éƒ¨ç½²åˆ†æ”¯: ${{ github.ref_name }}"

    - name: Failure Notification
      if: failure()
      run: |
        echo "âŒ AudioTextHub Docker éƒ¨ç½²å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ—¥å¿—ã€‚"
