name: Docker Deploy to Production

on:
  push:
    branches: [main, master]
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    # æ£€å‡ºä»£ç 
    - name: Checkout Code
      uses: actions/checkout@v3

    # è®¾ç½® Docker Buildx
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2

    # æ„å»º Docker é•œåƒ
    - name: Build Docker Image
      run: |
        docker build -t audiotexthub:latest .
        docker save audiotexthub:latest | gzip > audiotexthub.tar.gz

    # ä¸Šä¼ é•œåƒåˆ°æœåŠ¡å™¨
    - name: Upload Docker Image
      uses: appleboy/scp-action@master
      with:
        host: ${{ secrets.DEPLOY_HOST }}
        port: ${{ secrets.DEPLOY_PORT || 22 }}
        username: ${{ secrets.DEPLOY_USER }}
        password: ${{ secrets.DEPLOY_PASS }}
        source: "audiotexthub.tar.gz,docker-compose.prod.yml,Dockerfile"
        target: "/tmp/"

    # éƒ¨ç½²åˆ°æœåŠ¡å™¨
    - name: Deploy to Server
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.DEPLOY_HOST }}
        port: ${{ secrets.DEPLOY_PORT || 22 }}
        username: ${{ secrets.DEPLOY_USER }}
        password: ${{ secrets.DEPLOY_PASS }}
        command_timeout: 30m
        script: |
          set -e
          
          # å®šä¹‰å˜é‡
          APP_DIR="/var/www/audiotexthub"
          BACKUP_DIR="${APP_DIR}/backups"
          TIMESTAMP=$(date +%Y%m%d_%H%M%S)
          
          # åˆ›å»ºç›®å½•ç»“æ„
          echo "åˆ›å»ºç›®å½•ç»“æ„..."
          sudo mkdir -p ${APP_DIR}/{backups,logs,ssl}
          sudo chown -R $USER:$USER ${APP_DIR}
          cd ${APP_DIR}
          
          # å¤‡ä»½å½“å‰ç‰ˆæœ¬ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
          if [ -f "docker-compose.prod.yml" ]; then
            echo "å¤‡ä»½å½“å‰é…ç½®..."
            cp docker-compose.prod.yml ${BACKUP_DIR}/docker-compose.prod.yml.${TIMESTAMP}
          fi
          
          # å¤åˆ¶æ–°çš„æ–‡ä»¶
          cp /tmp/docker-compose.prod.yml ${APP_DIR}/
          cp /tmp/Dockerfile ${APP_DIR}/
          
          # æ£€æŸ¥ Docker æ˜¯å¦å®‰è£…
          if ! command -v docker &> /dev/null; then
            echo "Docker æœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£… Dockerï¼"
            exit 1
          fi
          
          # æ£€æŸ¥ Docker Compose æ˜¯å¦å®‰è£…
          if ! command -v docker-compose &> /dev/null; then
            # å°è¯•ä½¿ç”¨ docker compose (æ–°ç‰ˆæœ¬)
            if ! docker compose version &> /dev/null; then
              echo "Docker Compose æœªå®‰è£…ï¼Œæ­£åœ¨å®‰è£…..."
              # å®‰è£… Docker Compose
              sudo curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
              sudo chmod +x /usr/local/bin/docker-compose
            fi
          fi
          
          # åŠ è½½æ–°é•œåƒ
          echo "åŠ è½½ Docker é•œåƒ..."
          docker load < /tmp/audiotexthub.tar.gz
          rm -f /tmp/audiotexthub.tar.gz
          
          # æ£€æŸ¥ç¯å¢ƒå˜é‡æ–‡ä»¶
          if [ ! -f "${APP_DIR}/.env" ]; then
            echo "è­¦å‘Šï¼š.env æ–‡ä»¶ä¸å­˜åœ¨ï¼è¯·æ‰‹åŠ¨åˆ›å»ºå¹¶é…ç½®ç¯å¢ƒå˜é‡"
            echo "éœ€è¦é…ç½®ä»¥ä¸‹ç¯å¢ƒå˜é‡ï¼š"
            echo "NEXT_PUBLIC_API_URL=ä½ çš„è¯­éŸ³è¯†åˆ«APIåœ°å€"
            echo "AUTH_SECRET=è®¤è¯å¯†é’¥"
          fi
          
          
          # åœæ­¢æ—§å®¹å™¨
          echo "åœæ­¢æ—§å®¹å™¨..."
          docker-compose -f docker-compose.prod.yml down || docker compose -f docker-compose.prod.yml down || true
          
          # å¯åŠ¨æ–°å®¹å™¨
          echo "å¯åŠ¨æ–°å®¹å™¨..."
          if command -v docker-compose &> /dev/null; then
            docker-compose -f docker-compose.prod.yml up -d
          else
            docker compose -f docker-compose.prod.yml up -d
          fi
          
          # ç­‰å¾…å®¹å™¨å¯åŠ¨
          echo "ç­‰å¾…æœåŠ¡å¯åŠ¨..."
          sleep 10
          
          # æ˜¾ç¤ºå®¹å™¨çŠ¶æ€
          echo "å®¹å™¨çŠ¶æ€ï¼š"
          docker ps -a | grep -E "audiotexthub|nginx" || true
          
          # æ˜¾ç¤ºå®¹å™¨æ—¥å¿—
          echo "æœ€è¿‘çš„åº”ç”¨æ—¥å¿—ï¼š"
          docker logs --tail 50 audiotexthub-app-1 || docker logs --tail 50 audiotexthub_app_1 || true
          # Nginx æ—¥å¿—æ£€æŸ¥å·²ç§»é™¤
          
          # æ¸…ç†æ—§é•œåƒ
          echo "æ¸…ç†æœªä½¿ç”¨çš„é•œåƒ..."
          docker image prune -f || true
          
          echo "éƒ¨ç½²å®Œæˆï¼"

    # å¥åº·æ£€æŸ¥
    - name: Health Check
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.DEPLOY_HOST }}
        port: ${{ secrets.DEPLOY_PORT || 22 }}
        username: ${{ secrets.DEPLOY_USER }}
        password: ${{ secrets.DEPLOY_PASS }}
        script: |
          # ç­‰å¾…æœåŠ¡å®Œå…¨å¯åŠ¨
          echo "æ‰§è¡Œå¥åº·æ£€æŸ¥..."
          
          # æ£€æŸ¥å®¹å™¨çŠ¶æ€
          if ! docker ps | grep -q audiotexthub; then
            echo "é”™è¯¯ï¼šåº”ç”¨å®¹å™¨æœªè¿è¡Œï¼"
            docker ps -a
            exit 1
          fi
          
          # Nginx æ£€æŸ¥å·²ç§»é™¤ï¼Œå› ä¸ºä¸å†ä½¿ç”¨ nginx
          
          # HTTP å¥åº·æ£€æŸ¥
          MAX_ATTEMPTS=10
          ATTEMPT=1
          
          while [ $ATTEMPT -le $MAX_ATTEMPTS ]; do
            echo "å¥åº·æ£€æŸ¥å°è¯• $ATTEMPT/$MAX_ATTEMPTS..."
            
            # æ£€æŸ¥ HTTP ç«¯å£
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:80 || echo "000")
            echo "HTTP å“åº”ç : $HTTP_CODE"
            
            if [ "$HTTP_CODE" = "200" ]; then
              echo "âœ… å¥åº·æ£€æŸ¥é€šè¿‡ï¼"
              
              # æ˜¾ç¤ºå®¹å™¨ä¿¡æ¯
              echo "å®¹å™¨è¿è¡ŒçŠ¶æ€ï¼š"
              docker ps | grep audiotexthub
              
              # æ˜¾ç¤ºç«¯å£ç›‘å¬
              echo "ç«¯å£ç›‘å¬çŠ¶æ€ï¼š"
              netstat -tlpn | grep -E ':80|:443|:3000' || ss -tlpn | grep -E ':80|:443|:3000' || true
              
              # æµ‹è¯•APIç«¯ç‚¹
              echo "æµ‹è¯•APIç«¯ç‚¹..."
              curl -s http://localhost/api/test-speech-api | head -100 || true
              
              exit 0
            else
              echo "ç­‰å¾…æœåŠ¡å“åº”..."
              sleep 5
            fi
            
            ATTEMPT=$((ATTEMPT + 1))
          done
          
          # å¥åº·æ£€æŸ¥å¤±è´¥
          echo "âŒ å¥åº·æ£€æŸ¥å¤±è´¥ï¼"
          echo "åº”ç”¨å®¹å™¨æ—¥å¿—ï¼š"
          docker logs --tail 100 audiotexthub-app-1 || docker logs --tail 100 audiotexthub_app_1
          echo "Nginxå®¹å™¨æ—¥å¿—ï¼š"
          docker logs --tail 100 audiotexthub-nginx-1 || docker logs --tail 100 audiotexthub_nginx_1
          exit 1

    # æ¸…ç†å·¥ä½œæµäº§ç‰©
    - name: Cleanup
      if: always()
      run: |
        rm -f audiotexthub.tar.gz

    # æˆåŠŸé€šçŸ¥
    - name: Success Notification
      if: success()
      run: |
        echo "ğŸ‰ AudioTextHub Docker éƒ¨ç½²æˆåŠŸï¼"
        echo "éƒ¨ç½²æ—¶é—´: $(date)"
        echo "Git æäº¤: ${{ github.sha }}"
        echo "éƒ¨ç½²åˆ†æ”¯: ${{ github.ref_name }}"