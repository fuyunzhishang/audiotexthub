name: Docker Deploy to Production

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Build Docker Image
        run: |
          docker build -t audiotexthub:latest .
          docker save audiotexthub:latest | gzip > audiotexthub.tar.gz

      - name: Upload Docker Image
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          port: ${{ secrets.DEPLOY_PORT }}
          username: ${{ secrets.DEPLOY_USER }}
          password: ${{ secrets.DEPLOY_PASS }}
          source: "audiotexthub.tar.gz,docker-compose.prod.yml,Dockerfile"
          target: "/tmp/"

      - name: Deploy to Server
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          port: ${{ secrets.DEPLOY_PORT }}
          username: ${{ secrets.DEPLOY_USER }}
          password: ${{ secrets.DEPLOY_PASS }}
          command_timeout: 30m
          script: |
            set -e
            APP_DIR="/var/www/audiotexthub"
            BACKUP_DIR="${APP_DIR}/backups"
            TIMESTAMP=$(date +%Y%m%d_%H%M%S)

            echo "åˆ›å»ºç›®å½•ç»“æ„..."
            sudo mkdir -p "${APP_DIR}/{backups,logs,ssl}"
            sudo chown -R "$USER:$USER" "${APP_DIR}"
            cd "${APP_DIR}"

            if [ -f docker-compose.prod.yml ]; then
              echo "å¤‡ä»½å½“å‰é…ç½®..."
              cp docker-compose.prod.yml "${BACKUP_DIR}/docker-compose.prod.yml.${TIMESTAMP}"
            fi

            cp /tmp/docker-compose.prod.yml .
            cp /tmp/Dockerfile .

            if ! command -v docker >/dev/null; then
              echo "Docker æœªå®‰è£…ï¼"
              exit 1
            fi

            if ! docker compose version >/dev/null && ! command -v docker-compose >/dev/null; then
              echo "å®‰è£… Docker Compose..."
              sudo curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" \
                -o /usr/local/bin/docker-compose
              sudo chmod +x /usr/local/bin/docker-compose
            fi

            echo "åŠ è½½é•œåƒ..."
            sudo docker load < /tmp/audiotexthub.tar.gz
            rm -f /tmp/audiotexthub.tar.gz

            if [ ! -f .env ]; then
              echo "åˆ›å»ºé»˜è®¤ .env æ–‡ä»¶..."
              cat << 'EOF' > .env
NEXT_PUBLIC_API_URL=http://localhost:3000
AUTH_SECRET=your-auth-secret-here
EOF
            fi

            echo "åœæ­¢æ—§å®¹å™¨..."
            docker-compose -f docker-compose.prod.yml down || docker compose -f docker-compose.prod.yml down || true

            echo "å¯åŠ¨æ–°å®¹å™¨..."
            if command -v docker-compose >/dev/null; then
              docker-compose -f docker-compose.prod.yml up -d
            else
              docker compose -f docker-compose.prod.yml up -d
            fi

            echo "ç­‰å¾…å¯åŠ¨..."
            sleep 10

            CONTAINER=$(docker ps --format '{{.Names}}' | grep audiotexthub | head -n1)

            echo "æ—¥å¿—è¾“å‡ºï¼š"
            docker logs --tail 50 "${CONTAINER}" || true

            echo "æ¸…ç†é•œåƒ..."
            docker image prune -f || true

      - name: Health Check
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          port: ${{ secrets.DEPLOY_PORT }}
          username: ${{ secrets.DEPLOY_USER }}
          password: ${{ secrets.DEPLOY_PASS }}
          script: |
            CONTAINER=$(docker ps --format '{{.Names}}' | grep audiotexthub | head -n1)
            if ! docker ps | grep -q "${CONTAINER}"; then
              echo "å®¹å™¨æœªè¿è¡Œï¼" && exit 1
            fi
            for i in {1..10}; do
              HTTP_CODE=$(curl -s -o /dev/null -w '%{http_code}' http://localhost:80 || echo 000)
              if [ "${HTTP_CODE}" = "200" ]; then
                echo "å¥åº·æ£€æŸ¥é€šè¿‡ï¼" && exit 0
              fi
              sleep 5
            done
            echo "å¥åº·æ£€æŸ¥å¤±è´¥ï¼" && docker logs --tail 100 "${CONTAINER}" && exit 1

      - name: Cleanup
        if: always()
        run: rm -f audiotexthub.tar.gz

      - name: Success Notification
        if: success()
        run: echo "ğŸ‰ éƒ¨ç½²æˆåŠŸï¼š${{ github.sha }} on ${{ github.ref_name }}"

      - name: Failure Notification
        if: failure()
        run: echo "âŒ éƒ¨ç½²å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ—¥å¿—ã€‚"
